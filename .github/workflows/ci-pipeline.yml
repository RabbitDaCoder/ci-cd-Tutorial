name: CD Pipeline to Google Cloud Run (staging and production)

on:
  push:
    branches:
      - staging
  workflow_dispatch: {}
  release:
    types: published

env:
  PORT: 5001
  IMAGE: ${{ vars.IMAGE }}:${{ github.sha }}

jobs:
  test:
    runs-on: ubuntu-latest
    name: Setup, test, and build project
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install dependencies
        run: npm ci

      - name: Test application
        run: npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    name: Setup project, Authorize GCP & Docker, Build & Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # Authenticate to GCP using the modern action
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # Set up gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Authenticate Docker to Docker Hub
      - name: Authenticate Docker Hub
        run: |
          echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USER }} --password-stdin

      # Build & push Docker image
      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ env.IMAGE }} .
          docker push ${{ env.IMAGE }}

      # Enable Billing API (optional, only once per project)
      - name: Enable Billing API
        run: |
          gcloud services enable cloudbilling.googleapis.com --project=${{ secrets.GCP_PROJECT_ID }}

      # Deploy to staging
      - name: Deploy to Staging
        if: github.ref != 'refs/heads/main'
        run: |
          gcloud run deploy ${{ vars.GCR_STAGING_PROJECT_NAME }} \
            --region ${{ vars.GCR_REGION }} \
            --image ${{ env.IMAGE }} \
            --platform managed \
            --allow-unauthenticated \
            --tag staging

      # Deploy to production (only on release)
      - name: Deploy to Production
        if: github.event_name == 'release' && github.event.action == 'published' && github.event.release.target_commitish == 'main'
        run: |
          gcloud run deploy ${{ vars.GCR_PROJECT_NAME }} \
            --region ${{ vars.GCR_REGION }} \
            --image ${{ env.IMAGE }} \
            --platform managed \
            --allow-unauthenticated \
            --tag production
